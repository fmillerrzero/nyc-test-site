<!DOCTYPE html>
<html>
<head>
    <title>NYC ODCV Opportunity Rankings | R-Zero</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="description" content="NYC building ODCV savings rankings - 585 buildings analyzed for energy efficiency opportunities">
    <meta name="keywords" content="ODCV, NYC buildings, energy efficiency, LL97 compliance, building automation">
    <style>
        :root {
            --rzero-primary: #0066cc;
            --rzero-primary-dark: #0052a3;
            --rzero-light-blue: #f0f7fa;
            --rzero-background: #ffffff;
        }
        
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            margin: 0; 
            padding: 20px; 
            background: #ffffff; 
        }
        
        .container { max-width: 1400px; margin: 0 auto; padding: 0 7.5%; }
        
        .header {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 118, 157, 0.08);
            margin-bottom: 30px;
            text-align: center;
        }
        
        .logo-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        h1 { 
            color: var(--rzero-primary); 
            margin: 0;
            font-size: 2.5em;
            font-weight: 700;
        }
        
        .subtitle { 
            color: #666; 
            margin: 10px 0 0 0;
            font-size: 1.1em;
        }
        
        .stats { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 20px; 
            margin-bottom: 30px; 
        }
        
        .stat { text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px; }
        .stat-card { padding: 15px; }
        .stat-value { font-size: 1.8em; font-weight: bold; color: var(--rzero-primary); }
        .stat-label { font-size: 0.9em; color: #666; }
        .big { font-size: 2.5em; font-weight: bold; color: var(--rzero-primary); }
        
        .clickable-link { color: var(--rzero-primary); text-decoration: none; cursor: pointer; }
        .clickable-link:hover { text-decoration: underline; }
        .portfolio-box { 
            background: white;
            border: 1px solid rgba(0, 118, 157, 0.2);
            padding: 30px; 
            border-radius: 12px; 
            margin-bottom: 30px; 
        }
        
        .portfolio-box h2 { 
            color: var(--rzero-primary); 
            margin-top: 0; 
        }
        
        .portfolio-tile:not(.selected):hover {
            background-color: rgba(0, 118, 157, 0.08) !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 118, 157, 0.2);
        }
        
        .portfolio-tile.selected {
            background-color: rgba(0, 118, 157, 0.15) !important;
            border: 3px solid var(--rzero-primary) !important;
            box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.3), 0 8px 20px rgba(0, 118, 157, 0.4) !important;
            transform: translateY(-3px) scale(1.02);
            position: relative;
        }
        
        /* Aggressively prevent any checkmarks */
        .portfolio-tile.selected::after,
        .portfolio-tile.selected::before,
        .portfolio-tile::after,
        .portfolio-tile::before,
        .portfolio-tile *::after,
        .portfolio-tile *::before {
            display: none !important;
            content: none !important;
            visibility: hidden !important;
        }
        
        /* Enhanced Savings Styling from Prospector */
        .savings-high {
            color: #1b5e20;
            font-weight: 700;
            position: relative;
        }
        
        .savings-high::before {
            content: 'â˜…';
            position: absolute;
            left: -15px;
            color: #ffc107;
        }
        
        .savings-medium {
            color: #f57c00;
            font-weight: 600;
        }
        
        .savings-low {
            color: #616161;
        }
        
        tr:nth-child(-n+10) .savings-high {
            background: linear-gradient(90deg, transparent 0%, rgba(76, 175, 80, 0.1) 50%, transparent 100%);
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .clickable-row { cursor: pointer; }
        .clickable-row:hover { background-color: rgba(0, 118, 157, 0.05); }
        .rzero-badge { display: inline-block; background: var(--rzero-primary); color: white; padding: 3px 8px; border-radius: 20px; font-size: 0.75em; font-weight: 600; }
        
        /* Enhanced styling from Prospector */
        .info-box { 
            background: #f8f8f8;
            border: 1px solid #ddd;
            padding: 15px; 
            margin-bottom: 20px;
            border-radius: 8px;
        }
        
        .info-box h2 { 
            color: var(--rzero-primary); 
            margin-top: 0; 
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        details summary {
            list-style: none;
            cursor: pointer;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        details summary::-webkit-details-marker {
            display: none;
        }

        details[open] summary span:last-child {
            transform: rotate(180deg);
            display: inline-block;
        }

        details summary span:last-child {
            transition: transform 0.3s ease;
            display: inline-block;
        }
        
        .portfolio-box { 
            background: white;
            border: 1px solid #ddd;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .table-wrapper::-webkit-scrollbar { width: 12px; }
        .table-wrapper::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 6px; }
        .table-wrapper::-webkit-scrollbar-thumb { background: var(--rzero-primary); border-radius: 6px; }
        .table-wrapper::-webkit-scrollbar-thumb:hover { background: var(--rzero-primary-dark); }
        td { padding: 10px; border-bottom: 1px solid #eee; vertical-align: middle; }
        tbody tr:hover { background: rgba(0, 118, 157, 0.02); transition: background 0.2s ease; }
        
        table { 
            width: 100%; 
            background: white; 
            border-collapse: collapse; 
            box-shadow: 0 4px 20px rgba(0, 118, 157, 0.08);
            border-radius: 12px;
            overflow: hidden;
        }
        
        th { 
            background: var(--rzero-primary); 
            color: white; 
            padding: 10px 8px; 
            text-align: left; 
            cursor: pointer; 
            font-weight: 600;
        }
        
        th:hover { background: var(--rzero-primary-dark); }
        .thumb-cell { width: 80px; padding: 5px !important; text-align: center; }
        tr:nth-child(even) { background-color: rgba(0, 118, 157, 0.01); }
        
        @media (max-width: 768px) {
            .stats { grid-template-columns: 1fr; }
            .container { padding: 0 5%; }
            th { font-size: 12px; padding: 8px 4px; }
            td { font-size: 12px; padding: 6px 4px; }
            .portfolio-tile { min-height: 80px !important; }
            #backToTop { bottom: 20px; right: 20px; }
        }
        
        /* Hide sort indicators by default */
        .sort-indicator { opacity: 0.5; }
        th:hover .sort-indicator { opacity: 1; }
        
        td { padding: 10px; border-bottom: 1px solid #eee; }
        tr:hover { background: #f5f5f5; }
        a { color: var(--rzero-primary); text-decoration: none; font-weight: 500; }
        a:hover { text-decoration: underline; }
        .building-thumb { width: 70px; height: 70px; object-fit: cover; border-radius: 8px; cursor: pointer; }
        .no-thumb { 
            width: 70px; 
            height: 70px; 
            background: #f8f9fa; 
            border: 1px solid rgba(0, 118, 157, 0.2);
            border-radius: 8px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            color: #999;
            font-size: 10px;
            text-align: center;
        }
        
        @media print {
            .header { background: white !important; box-shadow: none !important; }
            .portfolio-box, #occupancyChartSlim, #backToTop, button { display: none !important; }
            .table-wrapper { max-height: none !important; overflow: visible !important; }
            table { box-shadow: none !important; }
            th { background: #f0f0f0 !important; color: black !important; }
            a { color: black !important; text-decoration: none !important; }
            .building-thumb { max-width: 50px !important; max-height: 50px !important; }
        }
        
        .yes { color: #38a169; font-weight: bold; }
        .no { color: #c41e3a; font-weight: bold; }
        .urgent { color: #c41e3a; font-weight: bold; }
        .bas { color: #38a169; font-weight: 600; }
        .no-bas { color: #c41e3a; font-weight: 600; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo-header">
                <a href="https://rzero.com" target="_blank">
                    <img src="https://rzero.com/wp-content/uploads/2021/10/rzero-logo-pad.svg" alt="R-Zero Logo" style="width: 200px; height: 50px;">
                </a>
            </div>
            <h1>Prospector: NYC</h1>
            <p class="subtitle">NYC Building ODCV Opportunity Rankings</p>
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" style="color: #2e7d32;">$17.7M</div>
                <div class="stat-label">Year One Savings</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" style="color: #c41e3a;">32</div>
                <div class="stat-label">Buildings facing $14.5M 2026 LL97 Penalties</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">470</div>
                <div class="stat-label">Buildings with BAS</div>
            </div>
        </div>
        

        
        <div class="portfolio-box">
            <h2>Top Portfolios</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                <div class="portfolio-tile" onclick="filterByOwner('Vornado Realty Trust')" style="background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid rgba(0, 118, 157, 0.2); cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative; min-height: 100px;">
                    <img src="https://raw.githubusercontent.com/fmillerrzero/nyc-test-site/main/Logos/Vornado_Realty_Trust.png" alt="Vornado Realty Trust" style="position: absolute; top: 10px; right: 15px; max-height: 60px; max-width: 120px; opacity: 0.8;">
                    <strong style="color: var(--rzero-primary); display: block; margin-bottom: 5px;">Vornado Realty Trust</strong>
                    <span style="color: #666;">42 buildings â€¢ $1.1M savings</span>
                </div>
                <div class="portfolio-tile" onclick="filterByOwner('SL Green Realty')" style="background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid rgba(0, 118, 157, 0.2); cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative; min-height: 100px;">
                    <img src="https://raw.githubusercontent.com/fmillerrzero/nyc-test-site/main/Logos/SL_Green_Realty.png" alt="SL Green Realty" style="position: absolute; top: 15px; right: 15px; max-height: 40px; max-width: 80px; opacity: 0.8;">
                    <strong style="color: var(--rzero-primary); display: block; margin-bottom: 5px;">SL Green Realty</strong>
                    <span style="color: #666;">26 buildings â€¢ $1.7M savings</span>
                </div>
                <div class="portfolio-tile" onclick="filterByOwner('Kaufman Organization')" style="background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid rgba(0, 118, 157, 0.2); cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative; min-height: 100px;">
                    <img src="https://raw.githubusercontent.com/fmillerrzero/nyc-test-site/main/Logos/Kaufman_Organization.png" alt="Kaufman Organization" style="position: absolute; top: 15px; right: 15px; max-height: 40px; max-width: 80px; opacity: 0.8;">
                    <strong style="color: var(--rzero-primary); display: block; margin-bottom: 5px;">Kaufman Organization</strong>
                    <span style="color: #666;">23 buildings â€¢ $0.0M savings</span>
                </div>
            </div>
        </div>

        
        <!-- Occupancy Trend Section -->
        <div style="background: white; padding: 20px 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0, 118, 157, 0.08); margin-bottom: 30px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: var(--rzero-primary); margin: 0; font-size: 1.4em; font-weight: 600;">NYC Office Occupancy Recovery</h3>
                <div style="display: flex; gap: 25px; font-size: 0.95em;">
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <div style="width: 20px; height: 3px; background: #5B6FED; border-radius: 2px;"></div>
                        <span>NYC: <strong>76%</strong></span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <div style="width: 20px; height: 3px; background: #FF6B6B; border-radius: 2px;"></div>
                        <span>US Avg: <strong>66%</strong></span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <div style="width: 20px; height: 3px; background: #4ECDC4; border-radius: 2px;"></div>
                        <span>SF: <strong>47%</strong></span>
                    </div>
                </div>
            </div>
            <div style="height: 220px; position: relative;">
                <canvas id="occupancyChartSlim"></canvas>
            </div>
        </div>
        
        <div style="background: #f8f8f8; border: 1px solid #ddd; padding: 15px; margin-bottom: 20px;">
            <details>
                <summary style="cursor: pointer; font-size: 1.5em; color: var(--rzero-primary); font-weight: 600; padding: 10px 0;">
                    Behind the Rankings <span style="font-size: 0.8em; transition: transform 0.3s; display: inline-block;">â–¼</span>
                </summary>
                <div style="margin-top: 15px;">
                    <p>Buildings are ranked by <strong>SALES READINESS</strong>, not just savings amount. The scoring system (110 points total):</p>
                    <ul style="line-height: 1.8;">
                        <li><strong>Financial Impact (40 pts):</strong> ODCV savings & LL97 penalty avoidance</li>
                        <li><strong>BAS Infrastructure (30 pts):</strong> No BAS = 0 points (major barrier to sale)</li>
                        <li><strong>Owner Portfolio (20 pts):</strong> Large portfolios score higher (one pitch â†’ multiple buildings)</li>
                        <li><strong>Implementation Ease (10 pts):</strong> Fewer tenants + larger floors = easier installation</li>
                        <li><strong>Prestige Factors (10 pts):</strong> LEED certification, Energy Star ambitions, Class A buildings</li>
                    </ul>
                    <p style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-top: 15px; border: 1px solid #ffeeba;">
                        <strong>Example:</strong> A building with $1.4M savings but no BAS ranks #123, while a $539K building with perfect infrastructure ranks #1. Focus on the ready buyers!
                    </p>
                </div>
            </details>
        </div>
        
        <div style="display: flex; gap: 10px; margin-bottom: 20px; align-items: center;">
            <input type="text" id="search" onkeyup="filterTable()" placeholder="Search by address, owner, property manager" style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
            <button id="clearFilterBtn" onclick="clearAllFilters()" style="background: #e0e0e0; color: #999; border: none; padding: 10px 25px; border-radius: 8px; cursor: not-allowed; font-size: 16px; font-weight: 600; transition: all 0.2s;" disabled>
                Clear Filter
            </button>
            <button onclick="exportToCSV()" style="background: #38a169; color: white; border: none; padding: 10px 25px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600;">
                Export CSV
            </button>
        </div>
        
        <div id="resultCounter" style="background: #f8f9fa; padding: 10px 15px; border-radius: 8px; margin-bottom: 20px; font-size: 14px; color: #666;">
            Showing <span id="visibleCount">5</span> of <span id="totalCount">5</span> buildings
        </div>
        
        <div class="table-wrapper" style="overflow-x: auto; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 118, 157, 0.08); position: relative; max-height: calc(100vh - 200px); overflow-y: auto;">
        <table id="buildingTable" style="width: 100%; background: white; border-collapse: collapse; min-width: 900px;">
        <thead style="position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">
        <tr>
            <th class="thumb-cell">Image</th>
            <th onclick="sortTable(1)" style="cursor: pointer;">Rank <span class="sort-indicator">â†•</span></th>
            <th onclick="sortTable(2)" style="cursor: pointer;">Building <span class="sort-indicator">â†•</span></th>
            <th onclick="sortTable(3)" style="cursor: pointer;">Owner <span class="sort-indicator">â†•</span></th>
            <th onclick="sortTable(4)" style="cursor: pointer;">Manager <span class="sort-indicator">â†•</span></th>
            <th onclick="sortTable(5)" style="cursor: pointer;">Annual ODCV Savings <span class="sort-indicator">â†•</span></th>
            <th onclick="sortTable(6)" style="cursor: pointer;">Score <span class="sort-indicator">â†•</span></th>
            <th>Details</th>
        </tr>
        </thead>
        <tbody>

        <tr data-search="1472 broadway, new york, ny 10036 | 1472 broadway | 141 w 42 st | 143 w 42 st | 145 w 42 st | 147 w 42 st | 149 w 42 st | 151 w 42 st | 153 w 42 st | 155 w 42 st | 157 w 42 st | 1472 broadway | 1474 broadway | 1476 broadway | 1478 broadway | 1480 broadway | 1482 broadway | 1484 broadway | 1486 broadway | 1488 broadway | 1490 broadway | 4 times sq | 138 w 43 st | 140 w 43 st | 142 w 43 st | 144 w 43 st | 146 w 43 st | 148 w 43 st | 150 w 43 st | 152 w 43 st | 154 w 43 st | 156 w 43 st | 158 w 43 st | durst organization | durst organization | 1009950005 | durst organization" data-occupancy="70" class="clickable-row" onclick="if (!event.target.closest('a')) window.location.href='1009950005.html'">
            <td><img src="https://raw.githubusercontent.com/fmillerrzero/nyc-test-site/main/images/1009950005/1009950005_hero_thumbnail.jpg" 
                     alt="1472 Broadway" 
                     class="building-thumb" 
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                     onclick="window.location.href='1009950005.html'">
                <div class="no-thumb" style="display:none;" onclick="window.location.href='1009950005.html'">No image</div></td>
            <td><span class="rzero-badge">#1</span></td>
            <td>1472 Broadway</td>
            <td><a href="javascript:void(0)" onclick="event.stopPropagation(); filterByOwner('Durst Organization')" class="clickable-link">Durst Organization</a></td>
            <td><a href="javascript:void(0)" onclick="event.stopPropagation(); filterByManager('Durst Organization')" class="clickable-link">Durst Organization</a></td>
            <td class="savings-high" data-value="539290.0599999999">$539,290</td>
            <td>98.0</td>
            <td style="text-align: center;">
                <span style="color: var(--rzero-primary);">â†’</span>
            </td>
        </tr>
    
        <tr data-search="100 gold st, new york, ny 10038 | 100 gold st | 96 gold st | 98 gold st | 100 gold st | 102 gold st | 96-102 gold st | city of new york | dcas | 1000940025 | city of new york" data-occupancy="70" class="clickable-row" onclick="if (!event.target.closest('a')) window.location.href='1000940025.html'">
            <td><img src="https://raw.githubusercontent.com/fmillerrzero/nyc-test-site/main/images/1000940025/1000940025_hero_thumbnail.jpg" 
                     alt="100 Gold St" 
                     class="building-thumb" 
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                     onclick="window.location.href='1000940025.html'">
                <div class="no-thumb" style="display:none;" onclick="window.location.href='1000940025.html'">No image</div></td>
            <td><span class="rzero-badge">#2</span></td>
            <td>100 Gold St</td>
            <td><a href="javascript:void(0)" onclick="event.stopPropagation(); filterByOwner('City of New York')" class="clickable-link">City of New York</a></td>
            <td><a href="javascript:void(0)" onclick="event.stopPropagation(); filterByManager('DCAS')" class="clickable-link">DCAS</a></td>
            <td class="savings-medium" data-value="181235.01999999996">$181,235</td>
            <td>97.0</td>
            <td style="text-align: center;">
                <span style="color: var(--rzero-primary);">â†’</span>
            </td>
        </tr>
    
        <tr data-search="1515 broadway, new york, ny 10036 | 1515 broadway | 200 w 45 st | 1507 broadway | 1509 broadway | 1511 broadway | 1513 broadway | 1515 broadway | 1517 broadway | 1519 broadway | 1521 broadway | 201 w 44 st | 203 w 44 st | 205 w 44 st | 207 w 44 st | 209 w 44 st | 211 w 44 st | 213 w 44 st | 215 w 44 st | 217 w 44 st | 219 w 44 st | 1523 broadway | 1525 broadway | 1 astor plaza | sl green realty | sl green realty | 1010160036 | sl green" data-occupancy="70" class="clickable-row" onclick="if (!event.target.closest('a')) window.location.href='1010160036.html'">
            <td><img src="https://raw.githubusercontent.com/fmillerrzero/nyc-test-site/main/images/1010160036/1010160036_hero_thumbnail.jpg" 
                     alt="1515 Broadway" 
                     class="building-thumb" 
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                     onclick="window.location.href='1010160036.html'">
                <div class="no-thumb" style="display:none;" onclick="window.location.href='1010160036.html'">No image</div></td>
            <td><span class="rzero-badge">#3</span></td>
            <td>1515 Broadway</td>
            <td><a href="javascript:void(0)" onclick="event.stopPropagation(); filterByOwner('SL Green Realty')" class="clickable-link">SL Green Realty</a></td>
            <td><a href="javascript:void(0)" onclick="event.stopPropagation(); filterByManager('SL Green Realty')" class="clickable-link">SL Green Realty</a></td>
            <td class="savings-high" data-value="651112.0099999999">$651,112</td>
            <td>96.7</td>
            <td style="text-align: center;">
                <span style="color: var(--rzero-primary);">â†’</span>
            </td>
        </tr>
    
        <tr data-search="1290 ave of the americas, new york, ny 10104 | 1290 ave of the americas | 38 w 52 st | 40 w 52 st | 42 w 52 st | 44 w 52 st | 46 w 52 st | 48 w 52 st | 50 w 52 st | 52 w 52 st | 54 w 52 st | 56 w 52 st | 58 w 52 st | 60 w 52 st | 62 w 52 st | 64 w 52 st | 66 w 52 st | 68 w 52 st | 70 w 52 st | 72 w 52 st | 74 w 52 st | 1280 ave of the americas | 1282 ave of the americas | 1284 ave of the americas | 1286 ave of the americas | 1288 ave of the americas | 1290 ave of the americas | 1292 ave of the americas | 1294 ave of the americas | 1296 ave of the americas | 31 w 51 st | 33 w 51 st | 35 w 51 st | 37 w 51 st | 39 w 51 st | 41 w 51 st | 43 w 51 st | 45 w 51 st | 47 w 51 st | 49 w 51 st | 51 w 51 st | 53 w 51 st | 55 w 51 st | 57 w 51 st | 59 w 51 st | 61 w 51 st | 63 w 51 st | 65 w 51 st | 67 w 51 st | 69 w 51 st | 71 w 51 st | 73 w 51 st | vornado realty trust | cushman & wakefield | 1012670001 | vornado" data-occupancy="70" class="clickable-row" onclick="if (!event.target.closest('a')) window.location.href='1012670001.html'">
            <td><img src="https://raw.githubusercontent.com/fmillerrzero/nyc-test-site/main/images/1012670001/1012670001_hero_thumbnail.jpg" 
                     alt="1290 Ave Of The Americas" 
                     class="building-thumb" 
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                     onclick="window.location.href='1012670001.html'">
                <div class="no-thumb" style="display:none;" onclick="window.location.href='1012670001.html'">No image</div></td>
            <td><span class="rzero-badge">#4</span></td>
            <td>1290 Ave Of The Americas</td>
            <td><a href="javascript:void(0)" onclick="event.stopPropagation(); filterByOwner('Vornado Realty Trust')" class="clickable-link">Vornado Realty Trust</a></td>
            <td><a href="javascript:void(0)" onclick="event.stopPropagation(); filterByManager('Cushman & Wakefield')" class="clickable-link">Cushman & Wakefield</a></td>
            <td class="savings-high" data-value="1090509.21">$1,090,509</td>
            <td>96.6</td>
            <td style="text-align: center;">
                <span style="color: var(--rzero-primary);">â†’</span>
            </td>
        </tr>
    
        <tr data-search="245 park ave, new york, ny 10167 | 245 park ave | 482 lexington ave | 484 lexington ave | 486 lexington ave | 488 lexington ave | 490 lexington ave | 492 lexington ave | 494 lexington ave | 496 lexington ave | 121 e 46 st | 480 lexington ave | 101 e 46 st | 103 e 46 st | 105 e 46 st | 107 e 46 st | 109 e 46 st | 111 e 46 st | 113 e 46 st | 115 e 46 st | 117 e 46 st | 119 e 46 st | 125 e 46 st | 108 e 47 st | 245a park ave | 118 e 47 st | 247 park ave | 249 park ave | 251 park ave | 253 park ave | 255 park ave | 257 park ave | 480a lexington ave | 112 e 47 st | 245 park ave | 100 e 47 st | 102 e 47 st | 104 e 47 st | 106 e 47 st | sl green realty | sl green realty | 1013010001 | sl green" data-occupancy="70" class="clickable-row" onclick="if (!event.target.closest('a')) window.location.href='1013010001.html'">
            <td><img src="https://raw.githubusercontent.com/fmillerrzero/nyc-test-site/main/images/1013010001/1013010001_hero_thumbnail.jpg" 
                     alt="245 Park Ave" 
                     class="building-thumb" 
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                     onclick="window.location.href='1013010001.html'">
                <div class="no-thumb" style="display:none;" onclick="window.location.href='1013010001.html'">No image</div></td>
            <td><span class="rzero-badge">#5</span></td>
            <td>245 Park Ave</td>
            <td><a href="javascript:void(0)" onclick="event.stopPropagation(); filterByOwner('SL Green Realty')" class="clickable-link">SL Green Realty</a></td>
            <td><a href="javascript:void(0)" onclick="event.stopPropagation(); filterByManager('SL Green Realty')" class="clickable-link">SL Green Realty</a></td>
            <td class="savings-high" data-value="782678.02">$782,678</td>
            <td>95.9</td>
            <td style="text-align: center;">
                <span style="color: var(--rzero-primary);">â†’</span>
            </td>
        </tr>
    
        </tbody>
        </table>
        </div>
    </div>
    
    <script>
    // Global variable to track filter state
    var activeOwnerFilter = null;
    
    // Define filter functions early so they're available for onclick handlers
    function filterByOwner(ownerName) {
        // Check if this owner is already selected
        const isAlreadySelected = activeOwnerFilter === ownerName;
        
        if (isAlreadySelected) {
            // Unselect: clear filter and show all buildings
            activeOwnerFilter = null;
            
            // Clear search bar
            document.getElementById('search').value = '';
            
            // Remove selection styling
            document.querySelectorAll('.portfolio-tile').forEach(tile => {
                tile.classList.remove('selected');
            });
            
            // Show all rows
            const rows = document.querySelectorAll('#buildingTable tbody tr');
            rows.forEach(row => {
                row.style.display = '';
            });
            updateResultCounter(rows.length);
        } else {
            // Select: apply filter
            activeOwnerFilter = ownerName;
            
            // Populate search bar with owner name
            document.getElementById('search').value = ownerName;
            
            // Remove previous selection styling
            document.querySelectorAll('.portfolio-tile').forEach(tile => {
                tile.classList.remove('selected');
            });
            
            // Add selection styling to clicked tile
            document.querySelectorAll('.portfolio-tile').forEach(tile => {
                if (tile.querySelector('strong') && tile.querySelector('strong').textContent === ownerName) {
                    tile.classList.add('selected');
                }
            });
            
            // Filter rows
            const rows = document.querySelectorAll('#buildingTable tbody tr');
            let visibleCount = 0;
            rows.forEach(row => {
                const ownerCell = row.cells[3];
                const isMatch = ownerCell && ownerCell.textContent.trim() === ownerName;
                row.style.display = isMatch ? '' : 'none';
                if (isMatch) visibleCount++;
            });
            updateResultCounter(visibleCount);
        }
        
        updateClearButtonState();
    }
    
    function filterByManager(managerName) {
        // Update active filter to track manager filters too
        activeOwnerFilter = managerName;
        
        // Populate search bar with manager name
        document.getElementById('search').value = managerName;
        
        // Remove active styling from portfolio tiles
        document.querySelectorAll('.portfolio-tile').forEach(tile => {
            tile.classList.remove('selected');
        });
        
        const rows = document.querySelectorAll('#buildingTable tbody tr');
        let visibleCount = 0;
        rows.forEach(row => {
            const managerCell = row.cells[4];
            const isMatch = managerCell && managerCell.textContent.trim() === managerName;
            row.style.display = isMatch ? '' : 'none';
            if (isMatch) visibleCount++;
        });
        updateResultCounter(visibleCount);
        updateClearButtonState();
    }
    
    // Search functionality
    function filterTable() {
        const input = document.getElementById('search').value.toLowerCase();
        const rows = document.querySelectorAll('#buildingTable tbody tr');
        let visibleCount = 0;
        rows.forEach(row => {
            const searchText = row.getAttribute('data-search');
            const isVisible = searchText && searchText.includes(input);
            row.style.display = isVisible ? '' : 'none';
            if (isVisible) visibleCount++;
        });
        updateClearButtonState();
        updateResultCounter(visibleCount);
    }
    
    // Update result counter
    function updateResultCounter(count) {
        document.getElementById('visibleCount').textContent = count;
    }
    
    function updateClearButtonState() {
        const btn = document.getElementById('clearFilterBtn');
        const searchBox = document.getElementById('search');
        const hasActiveFilter = (searchBox.value.trim() !== '') || (activeOwnerFilter !== null);
        
        if (hasActiveFilter) {
            btn.disabled = false;
            btn.style.background = '#c41e3a';
            btn.style.color = 'white';
            btn.style.cursor = 'pointer';
            btn.onmouseover = function() { this.style.background='#a01729'; };
            btn.onmouseout = function() { this.style.background='#c41e3a'; };
        } else {
            btn.disabled = true;
            btn.style.background = '#e0e0e0';
            btn.style.color = '#999';
            btn.style.cursor = 'not-allowed';
            btn.onmouseover = null;
            btn.onmouseout = null;
        }
    }
    
    function clearAllFilters() {
        // Clear search box
        document.getElementById('search').value = '';
        
        // Reset active filter
        activeOwnerFilter = null;
        
        // Show all rows
        const rows = document.querySelectorAll('#buildingTable tbody tr');
        rows.forEach(row => {
            row.style.display = '';
        });
        
        // Remove active styling from portfolio tiles
        document.querySelectorAll('.portfolio-tile').forEach(tile => {
            tile.classList.remove('selected');
        });
        
        // Update button state
        updateClearButtonState();
    }
    
    // Helper to escape quotes in JavaScript strings
    function jsEscape(str) {
        return str.replace(/\/g, '\\').replace(/'/g, "\'").replace(/"/g, '\"');
    }
    
    // Export to CSV functionality
    function exportToCSV() {
        const table = document.getElementById('buildingTable');
        const rows = Array.from(table.querySelectorAll('tbody tr')).filter(row => row.style.display !== 'none');
        
        let csv = 'Rank,Building,Owner,Manager,Annual ODCV Savings,Score
';
        
        rows.forEach(row => {
            const cells = row.cells;
            const rank = cells[1].textContent.replace('#', '');
            const building = cells[2].textContent;
            const owner = cells[3].textContent;
            const manager = cells[4].textContent;
            const savings = cells[5].getAttribute('data-value');
            const score = cells[6].textContent;
            
            csv += `"${rank}","${building}","${owner}","${manager}","${savings}","${score}"
`;
        });
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'nyc_odcv_rankings.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    }
    
    // Sortable table functionality
    let sortDir = {};
    function sortTable(col) {
        const tbody = document.querySelector('#buildingTable tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        sortDir[col] = !sortDir[col];
        
        rows.sort((a, b) => {
            let aVal, bVal;
            
            // Use data-value for savings column
            if (col === 5) {
                aVal = parseFloat(a.cells[col].getAttribute('data-value') || 0);
                bVal = parseFloat(b.cells[col].getAttribute('data-value') || 0);
            } else if (col === 1 || col === 6) {
                // Numeric columns
                aVal = parseFloat(a.cells[col].textContent.replace(/[#$,]/g, '') || 0);
                bVal = parseFloat(b.cells[col].textContent.replace(/[#$,]/g, '') || 0);
            } else {
                // Text columns
                aVal = (a.cells[col].textContent || '').toLowerCase();
                bVal = (b.cells[col].textContent || '').toLowerCase();
            }
            
            if (sortDir[col]) {
                return aVal > bVal ? 1 : -1;
            } else {
                return aVal < bVal ? 1 : -1;
            }
        });
        
        tbody.innerHTML = '';
        rows.forEach(row => tbody.appendChild(row));
        
        // Update header arrows
        document.querySelectorAll('th').forEach((th, idx) => {
            if (idx > 0 && idx < 7) {
                th.innerHTML = th.innerHTML.replace(/[â†‘â†“â†•]/g, idx === col ? (sortDir[col] ? 'â†‘' : 'â†“') : 'â†•');
            }
        });
    }
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        updateClearButtonState();
        
        // Initialize any portfolio tiles that might be pre-selected
        const urlParams = new URLSearchParams(window.location.search);
        const ownerParam = urlParams.get('owner');
        if (ownerParam) {
            filterByOwner(ownerParam);
        }
        
        // Initialize occupancy chart
        const ctx = document.getElementById('occupancyChartSlim').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                datasets: [{
                    label: 'NYC',
                    data: [68, 70, 72, 73, 74, 75, 74, 73, 75, 76, 76, 76],
                    borderColor: '#5B6FED',
                    backgroundColor: 'rgba(91, 111, 237, 0.1)',
                    tension: 0.3,
                    borderWidth: 2,
                    pointRadius: 3,
                    pointHoverRadius: 5
                }, {
                    label: 'US Average',
                    data: [58, 60, 62, 63, 64, 65, 64, 63, 65, 66, 66, 66],
                    borderColor: '#FF6B6B',
                    backgroundColor: 'rgba(255, 107, 107, 0.1)',
                    tension: 0.3,
                    borderWidth: 2,
                    pointRadius: 3,
                    pointHoverRadius: 5
                }, {
                    label: 'San Francisco',
                    data: [42, 43, 44, 45, 46, 47, 46, 45, 46, 47, 47, 47],
                    borderColor: '#4ECDC4',
                    backgroundColor: 'rgba(78, 205, 196, 0.1)',
                    tension: 0.3,
                    borderWidth: 2,
                    pointRadius: 3,
                    pointHoverRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(0,0,0,0.8)',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        borderColor: '#ddd',
                        borderWidth: 1,
                        cornerRadius: 4,
                        padding: 8,
                        displayColors: true,
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + context.parsed.y + '%';
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: { display: false },
                        ticks: { font: { size: 11 } }
                    },
                    y: {
                        min: 40,
                        max: 80,
                        ticks: {
                            stepSize: 10,
                            callback: function(value) {
                                return value + '%';
                            },
                            font: { size: 11 }
                        },
                        grid: { color: 'rgba(0,0,0,0.05)' }
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            }
        });
    });
    
    // Back to top functionality
    function scrollToTop() {
        window.scrollTo({top: 0, behavior: 'smooth'});
    }
    
    // Show/hide back to top button
    window.onscroll = function() {
        const btn = document.getElementById('backToTop');
        if (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200) {
            btn.style.display = 'block';
        } else {
            btn.style.display = 'none';
        }
    };
    
    
    // Preload aerial videos for top 10 buildings
    async function preloadAerialVideos() {
        const API_KEY = 'AIzaSyDQdR4xY0a_qmEsYairsp6r6tXwh5qx_ho';
        const rows = document.querySelectorAll('tbody tr');
        const aerialVideos = {
            // Map of BBL to video IDs from aerial_videos.csv
            1000090014: 'wJql3ZGi_K9jUolEQJ4qPt',
            1000090029: 'pEmc7uTCM_sx1YCcOewv96',
            1000100014: 'DcQ6P1JnMl7AUk0A6vV3sv',
            1000100023: 'yhICKCWVtlmzcRdHYoZU7q',
            1000130001: '60TirLeoxiynVhDBCglxVv',
            1000130005: '79zaCfkDMpuFqoacM9DBgc',
            1000130027: 'D-F-dvcm6Zl6d8qHr700ff',
            1000160260: 'vp8EaH-CqQj3n_HA47lnbD',
            1000200004: 'fJeDptncNamObJOYonNjYJ',
            1000200009: 'hgOQx_tsHZQH8vij_jq98l'
        };
        
        // Preload first 10 buildings only
        for (let i = 0; i < Math.min(10, rows.length); i++) {
            const row = rows[i];
            const onclick = row.getAttribute('onclick');
            if (onclick) {
                const match = onclick.match(/(\d+)\.html/);
                if (match) {
                    const bbl = match[1];
                    const videoId = aerialVideos[bbl];
                    if (videoId) {
                        try {
                            // Preload video metadata
                            await fetch(`https://aerialview.googleapis.com/v1/videos:lookupVideo?key=${API_KEY}&videoId=${videoId}`);
                            console.log(`Preloaded aerial video for ${bbl}`);
                        } catch (e) {
                            console.log(`Failed to preload ${bbl}:`, e);
                        }
                    }
                }
            }
        }
    }
    
    // Call on page load
    setTimeout(preloadAerialVideos, 2000);
    </script>
    
    <!-- Back to Top Button -->
    <button id="backToTop" onclick="scrollToTop()" style="
        position: fixed;
        bottom: 80px;
        right: 30px;
        width: 50px;
        height: 50px;
        background: var(--rzero-primary);
        color: white;
        border: none;
        border-radius: 50%;
        font-size: 20px;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        z-index: 1000;
        display: none;
    ">
        <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
            <path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"/>
        </svg>
    </button>
    
    <div style="text-align: center; color: black; font-size: 14px; padding: 20px 0;">
        Build: {datetime.now(pytz.timezone('America/Mexico_City')).strftime('%I:%M:%S %p CST')} | y{' | ' + sys.argv[1] if len(sys.argv) > 1 else ''}
    </div>
</body>
</html>
